
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>FluentGenie - AI 护眼英语练习</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { 
          font-family: 'Inter', sans-serif; 
          background-color: #F9F7F2;
          -webkit-tap-highlight-color: transparent;
          overflow-x: hidden;
        }
        #root { padding-top: env(safe-area-inset-top); padding-bottom: env(safe-area-inset-bottom); }

        #error-overlay {
            display: none;
            position: fixed;
            inset: 0;
            background: #F9F7F2;
            z-index: 9999;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 2rem;
            text-align: center;
        }

        .loading-pulse {
            width: 48px;
            height: 48px;
            border: 4px solid #6B8E6B20;
            border-top-color: #6B8E6B;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        .error-card {
            background: white;
            padding: 2rem;
            border-radius: 2.5rem;
            box-shadow: 0 20px 50px rgba(0,0,0,0.05);
            max-width: 90%;
            width: 400px;
        }
    </style>
    
    <script>
        window.APP_LOADED = false;
        
        const checkResource = async (url) => {
            try {
                const start = Date.now();
                await fetch(url, { mode: 'no-cors', cache: 'no-cache' });
                return { ok: true, time: Date.now() - start };
            } catch (e) {
                return { ok: false };
            }
        };

        async function runDiagnostic() {
            const btn = document.getElementById('diag-btn');
            const originalText = btn.innerText;
            btn.innerText = "诊断中...";
            btn.disabled = true;

            const results = {
                'React核心库': await checkResource('https://cdn.jsdelivr.net/npm/react@19.0.0/+esm'),
                'GenAI SDK': await checkResource('https://esm.sh/@google/genai@1.37.0'),
                'Tailwind样式': await checkResource('https://cdn.tailwindcss.com'),
                '谷歌字体库': await checkResource('https://fonts.googleapis.com')
            };

            let report = "【网络连通性诊断】\n\n";
            let failCount = 0;
            for (const [name, res] of Object.entries(results)) {
                if (res.ok) {
                    report += `✅ ${name}: 连通正常 (${res.time}ms)\n`;
                } else {
                    report += `❌ ${name}: 连接失败 (请检查网络阻断)\n`;
                    failCount++;
                }
            }

            btn.innerText = originalText;
            btn.disabled = false;

            if (failCount > 0) {
                alert(report + "\n建议措施：\n1. 尝试切换手机流量/Wi-Fi\n2. 检查浏览器是否开启了过度严格的广告过滤\n3. 检查您的设备时间是否正确。");
            } else {
                alert(report + "\n资源连接正常，但应用仍无法启动。可能是因为您的浏览器版本过低不支持 ES 模块。");
            }
        }

        function showError(msg) {
            const overlay = document.getElementById('error-overlay');
            const errorMsg = document.getElementById('error-message');
            if (overlay && errorMsg) {
                overlay.style.display = 'flex';
                errorMsg.innerText = msg;
                const debugHost = document.getElementById('debug-host');
                if (debugHost) debugHost.innerText = window.location.protocol + "//" + window.location.hostname;
            }
        }

        window.addEventListener('error', (event) => {
            if (event.target.tagName === 'SCRIPT' || event.message?.includes('import')) {
                showError('脚本加载失败。请检查网络环境或尝试刷新页面。');
            }
        }, true);

        window.addEventListener('DOMContentLoaded', () => {
            // 放宽环境检查：本地调试、Google AI Studio、Cloudflare Pages 均视为受信任
            const isLocal = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';
            const isTrustedHost = window.location.hostname.includes('google.com') || window.location.hostname.includes('pages.dev');
            const isHttps = window.location.protocol === 'https:';

            if (!isHttps && !isLocal && !isTrustedHost) {
                showError('为了启用麦克风和隐私保护，请确保使用 HTTPS 链接访问应用。');
                return;
            }

            // 加载超时监控
            setTimeout(() => {
                if (!window.APP_LOADED) {
                    showError('连接超时。请尝试切换到更稳定的 Wi-Fi 网络或使用流量重试。');
                }
            }, 15000);
        });
    </script>

<script type="importmap">
{
  "imports": {
    "@google/genai": "https://esm.sh/@google/genai@^1.37.0",
    "react/": "https://cdn.jsdelivr.net/npm/react@19.0.0/",
    "react": "https://cdn.jsdelivr.net/npm/react@19.0.0/+esm",
    "react-dom/": "https://cdn.jsdelivr.net/npm/react-dom@19.0.0/",
    "react-dom": "https://cdn.jsdelivr.net/npm/react-dom@19.0.0/+esm"
  }
}
</script>
<script type="module" src="index.tsx"></script>
</head>
<body class="text-stone-800">
    <div id="root">
        <div class="fixed inset-0 flex flex-col items-center justify-center bg-[#F9F7F2]">
            <div class="loading-pulse mb-4"></div>
            <p class="text-xs font-bold text-[#8BA888] tracking-widest uppercase">Genie 正在赶来...</p>
            <p class="text-[10px] text-stone-400 mt-2">正在优化移动端加载路径</p>
        </div>
    </div>

    <div id="error-overlay">
        <div class="error-card flex flex-col items-center">
            <div class="w-16 h-16 bg-red-50 text-red-500 rounded-full flex items-center justify-center mb-6">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor" class="w-8 h-8">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m9-.75a9 9 0 1 1-18 0 9 9 0 0 1 18 0Zm-9 3.75h.008v.008H12v-.008Z" />
                </svg>
            </div>
            <h2 class="text-lg font-bold text-stone-800 mb-2">连接练习室失败</h2>
            <p id="error-message" class="text-sm text-stone-500 leading-relaxed mb-8 px-4"></p>
            <div class="flex flex-col gap-3 w-full">
                <button onclick="window.location.reload()" class="w-full py-4 bg-[#6B8E6B] text-white rounded-2xl font-bold shadow-lg active:scale-95 transition-transform">重试连接</button>
                <button id="diag-btn" onclick="runDiagnostic()" class="w-full py-3 bg-white border border-[#E8E2D6] text-[#8BA888] rounded-2xl font-bold text-xs">一键诊断网络问题</button>
                <p class="text-[10px] text-stone-400 mt-2">调试环境: <span id="debug-host"></span></p>
            </div>
        </div>
    </div>
</body>
</html>
