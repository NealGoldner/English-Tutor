
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>FluentGenie - AI 护眼英语练习</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { 
          font-family: 'Inter', sans-serif; 
          background-color: #F9F7F2;
          -webkit-tap-highlight-color: transparent;
          overflow-x: hidden;
        }
        #root { padding-top: env(safe-area-inset-top); padding-bottom: env(safe-area-inset-bottom); }

        #error-overlay {
            display: none;
            position: fixed;
            inset: 0;
            background: #F9F7F2;
            z-index: 9999;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 2rem;
            text-align: center;
        }

        .loading-pulse {
            width: 48px;
            height: 48px;
            border: 4px solid #6B8E6B20;
            border-top-color: #6B8E6B;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        .error-card {
            background: white;
            padding: 2rem;
            border-radius: 2.5rem;
            box-shadow: 0 20px 50px rgba(0,0,0,0.05);
            max-width: 90%;
            width: 400px;
        }
    </style>
    
    <script>
        window.APP_LOADED = false;
        
        // 全局错误捕获
        window.addEventListener('error', (event) => {
            if (event.target.tagName === 'SCRIPT' || event.message?.includes('import')) {
                showError('核心脚本加载失败。这通常是因为您的网络无法访问某些资源服务器（如 esm.sh）。请尝试切换 Wi-Fi 或开启/关闭流量再试。');
            }
        }, true);

        window.addEventListener('unhandledrejection', (event) => {
            console.error('Unhandled rejection:', event.reason);
        });

        function showError(msg) {
            const overlay = document.getElementById('error-overlay');
            const errorMsg = document.getElementById('error-message');
            if (overlay) {
                overlay.style.display = 'flex';
                errorMsg.innerText = msg;
            }
        }

        window.addEventListener('DOMContentLoaded', () => {
            // 1. 安全环境检测
            if (window.location.protocol !== 'https:' && window.location.hostname !== 'localhost') {
                showError('为了保护隐私并使用麦克风，请确保地址栏以 https:// 开头。');
                return;
            }

            // 2. 超时监控：12秒还没加载完就报错
            setTimeout(() => {
                if (!window.APP_LOADED) {
                    showError('加载时间过长。可能是 CDN 资源加载缓慢或被拦截。建议尝试：\n1. 刷新页面\n2. 切换到 Wi-Fi 网络\n3. 确保没有开启广告过滤插件');
                }
            }, 12000);
        });
    </script>

<script type="importmap">
{
  "imports": {
    "@google/genai": "https://esm.sh/@google/genai@^1.37.0",
    "react/": "https://esm.sh/react@^19.2.3/",
    "react": "https://esm.sh/react@^19.2.3",
    "react-dom/": "https://esm.sh/react-dom@^19.2.3/"
  }
}
</script>
<script type="module">
    // 标记应用开始加载
    import 'react';
    import 'react-dom';
    // 如果上面两个成功加载，说明网络环境 OK
</script>
<script type="module" src="index.tsx"></script>
</head>
<body class="text-stone-800">
    <div id="root">
        <div class="fixed inset-0 flex flex-col items-center justify-center bg-[#F9F7F2]">
            <div class="loading-pulse mb-4"></div>
            <p class="text-xs font-bold text-[#8BA888] tracking-widest uppercase">Genie 正在赶来...</p>
            <p class="text-[10px] text-stone-400 mt-2">正在建立免翻墙安全隧道</p>
        </div>
    </div>

    <!-- 增强版错误诊断层 -->
    <div id="error-overlay">
        <div class="error-card flex flex-col items-center">
            <div class="w-16 h-16 bg-red-50 text-red-500 rounded-full flex items-center justify-center mb-6">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor" class="w-8 h-8">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m9-.75a9 9 0 1 1-18 0 9 9 0 0 1 18 0Zm-9 3.75h.008v.008H12v-.008Z" />
                </svg>
            </div>
            <h2 class="text-lg font-bold text-stone-800 mb-2">连接练习室失败</h2>
            <p id="error-message" class="text-sm text-stone-500 leading-relaxed mb-8"></p>
            <div class="flex flex-col gap-3 w-full">
                <button onclick="window.location.reload()" class="w-full py-4 bg-[#6B8E6B] text-white rounded-2xl font-bold shadow-lg active:scale-95 transition-transform">重试连接</button>
                <p class="text-[10px] text-stone-400">当前域名: <span id="debug-host"></span></p>
            </div>
        </div>
        <script>document.getElementById('debug-host').innerText = window.location.hostname;</script>
    </div>
</body>
</html>
