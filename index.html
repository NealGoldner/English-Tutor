
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>FluentGenie - AI 英语练习</title>
    <!-- 使用 fastly 节点提高移动端稳定性 -->
    <script src="https://fastly.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.js"></script>
    <style>
        /* 移除谷歌字体，使用系统高性能字体族，防止阻塞 */
        body { 
          font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; 
          background-color: #F9F7F2;
          -webkit-tap-highlight-color: transparent;
          overflow-x: hidden;
          color: #2D3748;
        }
        #root { padding-top: env(safe-area-inset-top); padding-bottom: env(safe-area-inset-bottom); }

        #error-overlay {
            display: none;
            position: fixed;
            inset: 0;
            background: #F9F7F2;
            z-index: 9999;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 2rem;
            text-align: center;
        }

        .loading-pulse {
            width: 40px;
            height: 40px;
            border: 3px solid #6B8E6B20;
            border-top-color: #6B8E6B;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        .error-card {
            background: white;
            padding: 2rem;
            border-radius: 2rem;
            box-shadow: 0 10px 30px rgba(0,0,0,0.05);
            max-width: 90%;
            width: 380px;
        }
    </style>
    
    <script>
        window.APP_LOADED = false;
        
        const checkResource = async (url) => {
            try {
                const start = Date.now();
                // 使用 no-cors 尝试探测，但 fetch 在部分移动浏览器下对 blocked 资源会直接 throw
                const controller = new AbortController();
                const id = setTimeout(() => controller.abort(), 5000);
                await fetch(url, { mode: 'no-cors', cache: 'no-cache', signal: controller.signal });
                clearTimeout(id);
                return { ok: true, time: Date.now() - start };
            } catch (e) {
                return { ok: false };
            }
        };

        async function runDiagnostic() {
            const btn = document.getElementById('diag-btn');
            btn.innerText = "正在检测网络...";
            btn.disabled = true;

            const results = {
                '核心库镜像': await checkResource('https://fastly.jsdelivr.net/npm/react@19.0.0/+esm'),
                'GenAI 节点': await checkResource('https://esm.run/@google/genai@1.37.0'),
                'CSS 样式节点': await checkResource('https://fastly.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.js')
            };

            let report = "【网络详细诊断】\n\n";
            let failCount = 0;
            for (const [name, res] of Object.entries(results)) {
                if (res.ok) {
                    report += `✅ ${name}: 正常 (${res.time}ms)\n`;
                } else {
                    report += `❌ ${name}: 无法连接\n`;
                    failCount++;
                }
            }

            btn.innerText = "重新诊断";
            btn.disabled = false;

            if (failCount > 0) {
                alert(report + "\n原因：您的网络环境阻断了必要的云端库文件。\n\n建议：\n1. 请务必开启代理/加速器并选择“全局模式”。\n2. 尝试连接不同的 Wi-Fi。");
            } else {
                alert(report + "\n网络正常，请点击下方“刷新应用”。");
            }
        }

        function showError(msg) {
            const overlay = document.getElementById('error-overlay');
            const errorMsg = document.getElementById('error-message');
            if (overlay && errorMsg) {
                overlay.style.display = 'flex';
                errorMsg.innerText = msg;
            }
        }

        window.addEventListener('error', (event) => {
            if (event.target.tagName === 'SCRIPT' || event.message?.includes('import')) {
                showError('资源加载被拦截，请确保已开启网络加速。');
            }
        }, true);

        window.addEventListener('DOMContentLoaded', () => {
            setTimeout(() => {
                if (!window.APP_LOADED) {
                    showError('响应超时。请尝试切换网络环境或开启加速工具。');
                }
            }, 10000); // 缩短等待时间，快速报错
        });
    </script>

<script type="importmap">
{
  "imports": {
    "@google/genai": "https://esm.run/@google/genai@1.37.0",
    "react/": "https://fastly.jsdelivr.net/npm/react@19.0.0/",
    "react": "https://fastly.jsdelivr.net/npm/react@19.0.0/+esm",
    "react-dom/": "https://fastly.jsdelivr.net/npm/react-dom@19.0.0/",
    "react-dom": "https://fastly.jsdelivr.net/npm/react-dom@19.0.0/+esm"
  }
}
</script>
<script type="module" src="index.tsx"></script>
</head>
<body>
    <div id="root">
        <div class="fixed inset-0 flex flex-col items-center justify-center bg-[#F9F7F2]">
            <div class="loading-pulse mb-6"></div>
            <p class="text-xs font-bold text-[#8BA888] tracking-widest uppercase">Genie 正在通过镜像节点加载...</p>
        </div>
    </div>

    <div id="error-overlay">
        <div class="error-card flex flex-col items-center">
            <div class="w-14 h-14 bg-red-50 text-red-500 rounded-full flex items-center justify-center mb-6">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor" class="w-7 h-7">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m9-.75a9 9 0 1 1-18 0 9 9 0 0 1 18 0Zm-9 3.75h.008v.008H12v-.008Z" />
                </svg>
            </div>
            <h2 class="text-base font-bold text-stone-800 mb-2">手机网络连接受限</h2>
            <p id="error-message" class="text-xs text-stone-500 leading-relaxed mb-8 px-4">核心组件加载失败，这通常是因为您的网络环境屏蔽了开发资源库。</p>
            <div class="flex flex-col gap-3 w-full">
                <button onclick="window.location.reload()" class="w-full py-4 bg-[#6B8E6B] text-white rounded-2xl font-bold shadow-lg active:scale-95">刷新应用</button>
                <button id="diag-btn" onclick="runDiagnostic()" class="w-full py-3 bg-white border border-stone-200 text-[#8BA888] rounded-2xl font-bold text-xs">诊断网络问题</button>
            </div>
        </div>
    </div>
</body>
</html>
